Bootstrap: docker
From: almalinux:latest

%environment
     # Point to OMPI binaries, libraries, man pages
    export OMPI_DIR=/usr/lib/openmpi-4.1.4
    export PATH="$OMPI_DIR/bin:$PATH"
    export LD_LIBRARY_PATH="$OMPI_DIR/lib:$LD_LIBRARY_PATH"
    export MANPATH="$OMPI_DIR/share/man:$MANPATH"
    # For OpenFOAM
    export PATH=$OMPI_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH

%files
    src/OpenFOAM-v2212.tgz /usr/lib
    src/ThirdParty-v2212.tgz /usr/lib
    src/openmpi-4.1.4.tar.gz /usr/lib
    # src/pmix-4.2.3.tar.gz /usr/lib

%post -c /bin/bash

    # -------- Update & upgrade --------
    dnf check-update
    dnf update
    dnf makecache --refresh

    # -------- Prerequisites --------
    dnf install gcc g++ gfortran make cmake boost-devel fftw flex bison zlib-devel ncurses-devel wget tar gzip \
      zlib boost-thread boost-system libXt-devel libXt perl python openssh-server libevent -y

    # -------- Install libraries --------
    cd /usr/lib

    # -------- OpenMPI --------
    tar -xf openmpi-4.1.4.tar.gz
    cd openmpi-4.1.4
    ./configure --prefix=$(pwd) --with-CC=/usr/bin/gcc CXX=/usr/bin/g++ FC=/usr/bin/gfortran  --with-slurm --with-pmi=/usr/include/slurm/ --with-pmi-libdir=/usr/lib/x86_64-linux-gnu/
    make -j
    make install

    # Export MPI Variables
    export OMPI_DIR=/usr/lib/openmpi-4.1.4
    export MPI_ROOT=$OMPI_DIR
    export PATH=$PATH:$OMPI_DIR/bin
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$OMPI_DIR/lib

    # OpenFOAM
    cd /usr/lib
    tar -xzf OpenFOAM-v2212.tgz
    tar -xzf ThirdParty-v2212.tgz

    # Clean extracted archives
    rm -f *.tgz *.gz

    # # Create OpenFOAM directories
    mkdir -p openfoam
    mv OpenFOAM-v2212/ ThirdParty-v2212/ openfoam/.
    cd openfoam
    mkdir -p user-v2212

    # Activate OpenFOAM environment
    source /usr/lib/openfoam/OpenFOAM-v2212/etc/bashrc

    # ThirdParty build
    cd ThirdParty-v2212

    ./Allwmake -j

    # # OpenFOAM build
    cd ../OpenFOAM-v2212
    ./Allwmake -j