Bootstrap: docker
From: opensuse/leap

%environment
    export OMPI_DIR=/usr/lib/openmpi-4.1.4
    export SINGULARITY_OMPI_DIR=$OMPI_DIR
    export SINGULARITYENV_APPEND_PATH=$OMPI_DIR/bin
    export SINGULAIRTYENV_APPEND_LD_LIBRARY_PATH=$OMPI_DIR/lib
    # For OpenFOAM
    export PATH=$OMPI_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH

%files
    src/OpenFOAM-v2212.tgz /usr/lib
    src/ThirdParty-v2212.tgz /usr/lib
    src/openmpi-4.1.4.tar.gz /usr/lib

%post

    # Prerequisites
    zypper refresh
    zypper update -y
    zypper install -y gcc12 gcc12-c++ gcc-fortran
    zypper install -y -t pattern
    zypper install -y cmake gnuplot flex libfl-devel readline-devel zlib-devel motif
    zypper install -y boost-devel cgal-devel gmp-devel mpfr-devel python-devel libXt-devel glu-devel
    zypper install -y wget tar gzip metis-devel

    ln -nsf /usr/bin/gcc-12 /usr/bin/gcc
    ln -nsf /usr/bin/g++-12 /usr/bin/g++

    export CC=/usr/bin/gcc-12
    export CXX=/usr/bin/g++-12

    # OpenMPI-4.1.4
    cd /usr/lib
    tar -xf openmpi-4.1.4.tar.gz
    cd openmpi-4.1.4
    ./configure --prefix=$(pwd) CC=/usr/bin/gcc-12 CXX=/usr/bin/g++-12 FC=/usr/bin/gfortran
    make -j
    make install

    # Export MPI Variables
    export OMPI_DIR=/usr/lib/openmpi-4.1.4
    export MPI_ROOT=$OMPI_DIR
    export PATH=$PATH:$OMPI_DIR/bin
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$OMPI_DIR/lib

    # OpenFOAM
    cd /usr/lib
    tar -xzf OpenFOAM-v2212.tgz
    tar -xzf ThirdParty-v2212.tgz

    # Clean extracted archives
    rm -f *.tgz *.gz

    # Create OpenFOAM directories
    mkdir -p openfoam
    mv OpenFOAM-v2212/ ThirdParty-v2212/ openfoam/.
    cd openfoam
    mkdir -p user-v2212


    # Activate OpenFOAM environment
    . /usr/lib/openfoam/OpenFOAM-v2212/etc/bashrc

    # ThirdParty build
    cd ThirdParty-v2212

    ./Allwmake -j

    # OpenFOAM build
    cd ../OpenFOAM-v2212
    ./Allwmake -j





    # Scratch

    # Additional libraries
    # wget https://src.fedoraproject.org/lookaside/pkgs/metis/metis-5.1.0.tar.gz/md5/5465e67079419a69e0116de24fce58fe/metis-5.1.0.tar.gz && tar -xzf metis-5.1.0.tar.gz
    # # wget http://glaros.dtc.umn.edu/gkhome/fetch/sw/metis/metis-5.1.0.tar.gz && tar -xzf metis-5.1.0.tar.gz
    #   wget https://gitlab.inria.fr/scotch/scotch/-/archive/v7.0.3/scotch-v7.0.3.tar.gz && tar -xzf scotch-v7.0.3.tar.gz

    # Set correct env variables and OpenMPI
    # sed -i 's/WM_PROJECT_USER_DIR=.*/WM_PROJECT_USER_DIR=\/usr\/lib\/openfoam\/user-v2212/' /usr/lib/openfoam/OpenFOAM-v2212/etc/bashrc
    # sed -i 's/WM_MPLIB=.*/WM_MPLIB=SYSTEMOPENMPI/' /usr/lib/openfoam/OpenFOAM-v2212/etc/bashrc
    #   sed -i 's/FOAM_MPI=.*/FOAM_MPI=openmpi-4.1.4/' /usr/lib/openfoam/OpenFOAM-v1706/etc/config.sh/mpi
    # # Scotch
    # # sed -i 's/SCOTCH_VERSION=.*/SCOTCH_VERSION=scotch-v7.0.3/' /usr/lib/openfoam/OpenFOAM-v1706/etc/config.sh/scotch
