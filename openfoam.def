Bootstrap: docker
From: almalinux:latest

%environment
    export OMPI_DIR=/usr/lib/openmpi-4.1.4
    export SINGULARITY_OMPI_DIR=$OMPI_DIR
    export SINGULARITYENV_APPEND_PATH=$OMPI_DIR/bin
    export SINGULAIRTYENV_APPEND_LD_LIBRARY_PATH=$OMPI_DIR/lib
    # For OpenFOAM
    export PATH=$OMPI_DIR/bin:$PATH
    export LD_LIBRARY_PATH=$OMPI_DIR/lib:$LD_LIBRARY_PATH

%files
    src/OpenFOAM-v2212.tgz /usr/lib
    src/ThirdParty-v2212.tgz /usr/lib
    src/openmpi-4.1.4.tar.gz /usr/lib

%post -c /bin/bash
    # Update & upgrade
    dnf check-update
    dnf update
    dnf makecache --refresh
    # Prerequisites
    # dnf groupinstall "Development Tools" -y
    dnf install gcc g++ gfortran make cmake boost-devel fftw flex bison zlib-devel ncurses-devel wget tar gzip \
      zlib boost-thread boost-system libXt-devel libXt perl python -y
    
    # OpenMPI-4.1.4
    cd /usr/lib
    tar -xf openmpi-4.1.4.tar.gz
    cd openmpi-4.1.4
    ./configure --prefix=$(pwd) CC=/usr/bin/gcc CXX=/usr/bin/g++ FC=/usr/bin/gfortran
    make -j
    make install

    # Export MPI Variables
    export OMPI_DIR=/usr/lib/openmpi-4.1.4
    export MPI_ROOT=$OMPI_DIR
    export PATH=$PATH:$OMPI_DIR/bin
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$OMPI_DIR/lib

    # OpenFOAM
    cd /usr/lib
    tar -xzf OpenFOAM-v2212.tgz
    tar -xzf ThirdParty-v2212.tgz

    # Clean extracted archives
    rm -f *.tgz *.gz

    # # Create OpenFOAM directories
    mkdir -p openfoam
    mv OpenFOAM-v2212/ ThirdParty-v2212/ openfoam/.
    cd openfoam
    mkdir -p user-v2212

    # Activate OpenFOAM environment
    source /usr/lib/openfoam/OpenFOAM-v2212/etc/bashrc

    # ThirdParty build
    cd ThirdParty-v2212

    ./Allwmake -j

    # # OpenFOAM build
    cd ../OpenFOAM-v2212
    ./Allwmake -j